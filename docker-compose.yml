version: '3.10'

services:
  model_controller:
    container_name: model_controller
    image: registry.cn-beijing.aliyuncs.com/yuemengrui/ai:py311-ubuntu20.04-0.1
    command: [ "/bin/bash", "-c", "/workspace/ModelController/docker_run.sh" ]
    volumes:
      - ./ModelController:/workspace/ModelController
    ports:
      - "24620:24620"
    restart: unless-stopped
    networks:
      - lmcenternet
    stdin_open: true
    tty: true
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:24620/ai/health" ]
      interval: 60s
      start_period: 60s
      timeout: 10s
      retries: 5

  baichuan2_13b_server:
    container_name: model_worker_baichuan2_13b_server
    image: registry.cn-beijing.aliyuncs.com/yuemengrui/ai:pytorch2.0.1-cuda11.8-cudnn8-ubuntu20.04-py311-v0.2
    command: [ "/bin/bash", "-c", "/workspace/ModelWorker/docker_run.sh" ]
    depends_on:
      model_controller:
        condition: service_healthy
        restart: true
    volumes:
      - ./ModelWorker:/workspace/ModelWorker
      - ./ModelWorker/configs/baichuan2_13b_configs.py:/workspace/ModelWorker/configs/configs.py
      - ./DATA/Models/Baichuan2-13B-Chat:/workspace/Models/Baichuan2-13B-Chat
    ports:
      - "24621:24621"
    restart: unless-stopped
    networks:
      - lmcenternet
    shm_size: "4gb"
    stdin_open: true
    tty: true
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:24621/ai/health" ]
      interval: 60s
      start_period: 120s
      timeout: 10s
      retries: 5
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              device_ids: [ "1" ]
              capabilities: [ gpu ]

networks:
  paimongptnet:
    driver: bridge
    name: lmcenternet
